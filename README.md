# Highload Instagram

> [Методические указания](https://github.com/init/highload/blob/main/homework_architecture.md)

## Тема и целевая аудитория

**Instagram** — американская социальная сеть для обмена фотографиями и видео, основанная Кевином Систромом и Майком Кригером.

### Факты про целевую аудиторию

Целевой аудиторией являются люди, имеющие отношение к бизнесу, большие компании, общеизвестные деятели и просто люди, которые хотят делиться своей жизнью в социальных сетях.

- В среднем количество активных пользователей достигает 2-х биллионов;
- Пользователи проводят в среднем 11 часов в месяц в соц. сети;
- 30.8% аудитории - люди от 18 до 24 лет, а  30.3% - люди от 25 до 34 года.

Страны лидеры по размеру аудитории на момент января 2023 года:

| Страна      | Пользователей в год, млн. |
| ----------- | ------------------------- |
| Индия       | 229.25                    |
| США         | 143.35                    |
| Бразилия    | 143.35                    |
| Индонезия   | 89.15                     |
| Турция      | 48.65                     |
| Япония      | 45.7                      |
| Мексика     | 36.7                      |

Распределние пользователей за последний месяц (Январь 2023):

| Страна                | Пользователей в месяц, млн. | Пользователей в месяц, %  |
| --------------------- | --------------------------- | ------------------------- |
| CША                   | 435                         | 16.65                     |
| Индия                 | 403.7                       | 10.90                     |
| Бразилия              | 200.2                       | 10.22                     |
| Турция                | 162.4                       | 3.55                      |
| Индонезия             | 161.5                       | 3.50                      |
| Остальные страны      | 1 500                       | 55.18                     |

### Минимально жизнеспособный продукт

1. Создание, редактирование, просмотр профиля;
2. Публикация фото и видео с продолжительностью не более 60 секунд;
3. Возможность поставить лайк и оставить комментарий к посту;
4. Возможность просматривать ленту с подписками.

## Расчет нагрузки

### Продуктовые метрики

1. Месячная аудитория: 2 биллиона.
2. Дневная аудитроия: 500 миллионов.
3. Среднее время онлайна пользователя - 7 мин. 42 сек. За это время пользователю удается просмотреть 10 страниц.
4. Средний размер хранилища пользователя:

#### Авторизация

Так как информацию насчет среднего количества входов в аккаунт и регистраций найти не удалось, прибегну к приблизительным расчетам.
Будем считать, что так как в среднем за день имеется 500 млн. активных пользователей, то и авторизаций производится столько же.

#### Регистрация

Перейдем к регистрации: за 2021 год было насчитано 1.21 биллиона пользователей, когда за 2022 1.3 биллиона. Это значит, что за год прибавилось 80 000 000 пользователей. Значит, грубой оценкой можно посчитать среднее количество регистраций в день: `8 * 10^7 / 365 = 219 178`. То есть количество регистраций в день достигает 219 тыс.

#### Лайки и комментарии

Информация о лайках и комментариях была найдена в источнике:

- Среднее количество лайков, оставляемых под постом: 1 261, но всего среднее кол-во лайков в день 2 биллиона;
- Среднее количество комментариев, оставляемых под постом: 24.5, но всего среднее кол-во комментариев в день 38 миллиона;

#### Лента

Чтобы посчитать среднее кол-во запросов на загрузку, предположу, что вся дневная аудитория будет загружать ленту хотя бы один раз. Пусть 1/4 пользователей загрузит ленту  один раз, вторая четверть два раза, третья четверть 3 раза и оставшаяся 4 раза. Итого, выходит:

> `0.25 * 500 000 000 * (1 + 2 + 3 + 4) = 1 250 000 000`

#### Сводная таблица по среднему количеству действий пользователя по типам в день

| Тип запроса               | Среднее количество действий (в день) |
| ------------------------- | ------------------------------------ |
| Авторизация / Регистрация | 500 млн.                             |
| Публикайия фото / видео   | 95 млн.                              |
| Проставление лайков       | 2 биллиона                           |
| Проставление комментариев | 38 млн.                              |
| Просмотр ленты            | 1 250 млн.                           |

### Технические метрики

#### Размер хранения в разбивке по типам данных

- Размер Постов

Начну с размера поста с *фотографией*: средний размер исходной фотографии составляет около 2 Мб. Однако, для хранения на серверах и передачи через сеть, изображение будет сжиматься с использованием алгоритмов оптимизации и сжатия. В результате, средний вес сжатой картинки на платформе составит примерно **300 Кб**.

Размер *видео* будет зависеть от многих характеристик, но будем брать грубую оценку в среднем. Отталкиваемся от битрейта видео - определяет количество бит, передаваемых в секунду и влияет на качество и размер видеофайла. Обычно на Instagram рекомендуется использовать битрейт от 2 до 5 Mbps [[1]](<https://www.puckermob.com/tech/everything-you-wanted-to-know-about-best-bitrate-for-instagram/>). Для примера возьмем средний битрейт видео в 3 Mbps. Расчет объема данных: для определения размера видеофайла в байтах нужно умножить средний битрейт на длительность видео (в секундах) и поделить на 8 для преобразования из мегабитов в байты.

> Размер видео (в байтах) = (Средний битрейт x Длительность видео) / 8

В нашем случае, длительность видео 10 секунд, а средний битрейт 3 Mbps:

> Размер видео (в байтах) = (3 Mbps x 10 сек) / 8 = 30 Mbps / 8 = 3.75 Мб

Размер видео (в байтах) = **3.75 Мб**

Описание к посту займет около 20 байт (возьмем в среднем 10 символов по 2 байта). Итого, пост с картинкой будет весить 300 Кб. В случае с видео - возьмем видео в 10 секунд, которое будет весить 3.75 Мб и пост будет уже весить 3.78 Мб.

С момента запуска приложения было насчитано около 50 миллиардов фотографий, в секунду загружается 1 074 фотографий. Значит, возьмем 3/4 постов с фотографией и 1/4 с видео и посчитаем приблизительный суммарный размер базы, которая будет хранить все посты:

> `50 000 000 000 * (0.75 * 0.3 + 0.25 * 3.78) = 5 850 000 000 Мб = 58 500 Тб = 58.5 Пб`

- Информация о пользователе

У пользователя будут следующие поля:

- `Имя, Фамилия, Никнейм`: все по 32 символа, каждый из которых весит байт;
- `Почта, Дата рождения`: 4 байта;
- `Пароль`: в захэшированном виде 32 байта;
- `Описание`: 64 симовла по байту каждый.

На одного пользователя:
> `30 + 30 + 30 + 4 * 125 000 + 4 + 4 = 500 098 байт = 4 Мб`

На всех пользователей понадобится
> `1 300 000 000 000 * 4 = 5.2 * 10^12 Мб = 4 959 106 Тб`

#### Сетевой трафик

Взглянем на авторизацию/регистрацию и посчитаем нагрузку:

> `246 000 000 (в день) * 4 Мб / (24 * 3600) = 11 388 Мб/с = 88 Гбит/с`

Рассмотрим загрузку поста. Зная, что за секунду загружается 1 074 постов, посчитаем нагрузку на сеть:

> `1 074 * (0.75 * 2.2 + 0.25 * 8.2) = 3 973.8 Мб/с = 31 Гбит/с`

Теперь посчитаем загрузку ленты. Ссылаясь на проделанные расчеты выше, получим:

> `[1 250 000 000 (в день) * 60 (кол-во просмотренных постов) * (0.75 * 2.2 + 0.25 * 8.2)] / (24 * 3 600) = 3 211 805 Мб/с = 25 092 Гбит/с`

Так как остальные запросы будут не настолько дорогие относительно этих двух, заложу на них 5 Гбит/с.

Итого, получу итоговую сетевую нагрузку:
> `88 + 31 + 25 092 = 25 211 Гбит/с`
Суточная нагрузка на сеть - `3 151 Гб * 3600 * 24 = 272 246 400 Гб/с`

### RPS в разбивке по типам запросов

Уже по полученным данным посчитаем кол-во запросов в секунду в среднем:

- Регистрация/Авторизация:   `500 000 000 / (24 * 3600) = 5 787 rps`
- Публикайия фото / видео:   `95 000 000 / (24 * 3600) = 1 099 rps`
- Проставление лайков:       `2 000 000 000 / (24 * 3600) = 23 148 rps`
- Проставление комментариев: `38 000 000 / (24 * 3600) = 439 rps`
- Просмотр ленты:            `1 250 000 000 / (24 * 3600) = 14 467 rps`

Теперь нужно нужно посчитать пиковую нагрузку.

| Тип запроса               | Средняя нагрузка, rps                | Пиковая нагрузка, rps |
| ------------------------- | ------------------------------------ | --------------------- |
| Авторизация / регистрация | 5 787                                |                       |
| Публикайия фото / видео   | 1 099                                | |
| Проставление лайков       | 23 148                               | |
| Проставление комментариев | 439                                  | |
| Просмотр ленты            | 14 467                               | |
| **Итого**                 | **44 941**                           | |

## Логическая схема

![Логическая схема](/img/logical_schema.png)

### Описание таблиц

1. Пользователи (users) - таблица со всеми необходимыми данными о пользователе.
    - Primary key: id пользователяj
2. Посты (posts) - таблица с постами пользователями, которая включает в себя все необходимое для отображения поста.
    - Primary key: id поста;
    - Foreign key: user_id.
3. Лайки (likes) - таблица с информацией, что i-й пользователь поставил лайк j-му посту.
    - Foreign key: user_id, post_id.
4. Комментарии (comments) - таблица с информацией, что i-й пользователь поставил лайк j-му посту с непустым сообщением.
    - Foreign key: user_id, post_id.
5. Подписки (subscriptions) - таблица с информацией о том, что i-й пользователь подписан на j-го.
    - Foreign key: creator_id, follower_id.
6. Сессии (sessions) - таблица со всеми сессиями пользователей.
    - Foreign key: user_id.

## Физическая схема

 ![Физическая схема](/img/physical_schema.png)

### Выбор БД

1. Сессии пользователей

    Сессии пользователей будут очень часто изменяться по очевидным причиам. Из-за этого нужно осуществить быстрый доступ на получение текущих пользователей, быстрое удаление и добавление. Таким образом их лучше всего хранить в оперативной памяти, с чем прекрасно будет справляться нереляцонная in-memory база данных - `Redis`. В данном случае, ключом будет значение сессии, а значением - id пользователя и дата истечения сессии.

2. Пользователи и посты

    Пользователи же будут находиться в реляционной базе `PostgreSQL`, так как она представляет возможность делать сложные запросы, устанавливать отношения для легкой организации и связывания данных, а также поддерживает обширный функционал для масштабирования. Однако аватарки пользователей хранить там же не представляется возможным за счет большого размера картинок всех пользователей, что будет заметно замедлять работу базы. Поэтому для хранения аватарок будет использоваться `Amazon S3-хранилище`, который имеет высокую скорость чтения, высокую доступность и долговечных данных. В самой же реляционной базе будем хранить ссылку на картунку в S3.

    Аналогично пользователям данные постов будем хранить в `PostgreSQL`, а картинки/видео в `S3-хранилище`.

3. Комментарии, лайки, подписки

    Данные хорошо ложаться на реляционную модель, поэтому будем хранить их в `PostgreSQL`.

### Индексы

- Индекс на поле `nickname` в таблице `users` будет нужен в случае того, если пользователь решит найти другого по никнейму. Таким образом индекс увеличит селективность по этому полю;
- Индекс на поле `user_id` в таблице `posts` нужен для быстрого поиска пользователя, пост которого был увиден;
- Индекс на поле `post_id` в таблице `comments` нужен для быстрой подгрузки всех комментраиев у посту;
- Индексы на поля `creator_id` и `follower_id` в таблице `subscriptions` будут полезны для улучшения селективности подписчиков и подписок соответственно.

### Шардирование

- Users: шардирование будет проводиться по range-based принципу для более равномерного распределения данных;
- Posts: здесь можно применить партиционирование по принципу range-based, а шардировать по разным инстансам по дате создания поста. Таким образом новые посты будут находиться в одном месте, что позволит быстро получать их для прогрузкки ленты или первых постов на странице пользователя. Старые же посты так же будут доставляться быстро;
- Comments: комментарии будет логично шардировать по такому же принципу, что и посты для согласованности данных, то есть на том же инстансе, что и посты нужной даты.

### Репликация

Для PostgreSQL будет сделана 1 Master, 3 Slaves репликация. Таким образом, когда на Master базу будут записываться данные, с Slave баз будет читаться информация. Также при отказе одного Slave узла чтение может продолжится посредством переключения на другой узел.

## Технологии

| Технология    | Область применения   | Мотивация      |
|-------------- | -------------------- | -------------- |
| Golang        | Backend dev          | Популярный, быстрый, читаемый, поддерживающий многопоточную и асинхронную работу язык. За счет своей опулярности имеет множество готовых решений для backend-разработки |
| TS / React    | Frontend dev         | TS за счет своей типизации позволит писать более понятный и читаемый код. React фреймворк имеет множество инструментов для эффективной разработки |
| PostgreSQL    | Database             | Реляционная база, дающая возможность масштабироваться за счет своего обширного функционала. Одна из лучших среди реляционных баз          |
| Redis         | Database             | In-memory база, хранящая данные в оперативной памяти, за счет чего ускоряет доступ к информации. Также предоставляет возможным шардирование и репликацию, что немало важно для высоконагруженного сервиса          |
| Amazon S3     | Cloud storage        | Одно из самых популярных и надежных хранилищ объектов, которое предоставляет масштабируемое, высокодоступное и безопасное хранение данных в облаке |
| Nginx         | Web-server           | Быстро отдает статику, поддерживает функционал кэширование и является отличным балансировщиком нагрузки |
| GitLab CI/CD  | CI/CD                | Обладает широким функционалом, включая интеграцию с Kubernetes, и обеспечивает интегрированную среду разработки (IDE) и контроль версий |
| Kubernetis    | Managment            | Является удобным для управления кластерами. Имеет множество преимуществ: легкое масшатбирование, эффективная отказоустойчивость, удобное управление приложениями и ресурсами |
| Docker        | Coneinerization      | Удобное развертование, изолированное окружение для каждого приложения, безопасность, а также удобство в использовании |
| Prometheus    | Monitoring           | Мониторинг производительности, быстрый сбор метрик, масштабируемость, доступная интеграция с Kubernetis |
| Grafana       | Visualizong          | Большой функционал для визуализации собранных метрик |
| gRPC          | RPC                  | Протокол удаленного вызова процедур, подходящих для большого списка нужд, с помощью которого с легкостью можно осуществить взаимодействие микросервисов          |

## Схема проекта

![Схема проекта](/img/architecture.png)

### Описание

Первоначально запросы поступают от пользователей через DNS-сервер, который по алгоритму Round-robin будет перенапрвлять на один из серверов-балансировщиков. Каждый из них будет перенапрявлять запрос на наименее загруженный сервер-бэкенд. У каждого сервера будет свой кэш запросов для быстрого ответа в случае популярного запроса.

Перейдем к кластеру бэкендов, которые будут обрабатывать запросы, выполнять бизнес логику и ходить дальше в микросервисы за нужными данными. Весь кластер будет управляться Kubernetes. Все метрики будут собираться в базе Prometheus. У бэкендов будут свои балансировщики нагрузки, задача которых будет заключаться в балансировке нагрузки между узлами микросервисов.

Рассмотрим микросервисы:

Каждый микросервис выполенен в виде кластера, чтобы также распределять нагрузку. Общение бэкендов с микросервисами будет осуществялться с помощью протокола gRPS.

1. Authorization microservice

    Этот микросервис будет отвечать за сессии пользователей. Как говорилось выше, он будет ходить в кластер Редиса. Сам редис будет реплицировать данные для поддержания отказоустойчивости и быстро возвращать сессии нужному узлу микросервиса. Микросервис будет определять к какому шарду нужно будет обратиться.

    Все микросервисы будут управляться Kubernetes, метрики отправляются в свой кластер Prometheus. У каждой базы тоже будет свой сборщик метрик. Все метрики в последствии будут отпрвляться в Grafana.

2. Users microservice

    Будет хоить в кластер базы Постгреса, особенности работы которой были описаны выше. На основе range-based шардирования определит, в какой узел ему идти.

3. Posts microservice

    Также ходит в Постгрес. В зависимости от запроса будет обращаться к шарду по принципу времени создания или по ранжированию.

4. Attachment microservice

    Ходит в кластер S3-хранилища. Для более быстрой работы будет настроена контентная адресация, позволяящая определить, к какому узлу обратиться. Внутри него в базе Редиса будет проверяться кэш. Иначе ищем информацию в храниоище S3.

## Список серверов

### Балансировщики (Nginx)

Для того, чтобы обеспечивать балансировку средней нагрузки (41 700 rps) и отдачи статики, посчитаем сколько и каких сервером нужно. Сетевая нагрузка 25 211 Гбит/с.  Возьмем процессор, способный обрабатывать наши запросы. Пусть у него будет 30 CPU, 128 Гб RAM. Учитывая пиковые нагрузки, такой сервер сможет обработать около 2400 запросов в секунду. Возьмем [41 700 / 2 400 + 50 (для пиковой нагрузки)] = 67 серверов-балансировщиков.

### Бэкенды

Возьмем также 30 CPU, но 256 Гб RAM на каждый сервер, так как у приложений будет более сложная логика в отличие от nginx. Стоит учесть, что серверы будут ходить в микросервисы для получения нужной информации.

### Микросервисы

1. Auth microservice

    Имеем 2 847 rps в среднем, пиковая нагрузка 50 000 rps. Сетевая нагрузка - 88 Гбит/с

2. Users microservice

    23 148 (лайки) + 439 (комментарии) = 23 587 rps в среднем, 100 000 rps на пике. 31 Гбит/с

3. Posts microservice

    23 148 (лайки) + 439 (комментарии) + 14 467 (лента) = 38 024 rps в среднем, 100 000 rps на пике. 25 092 Гбит/с

4. Attachments microservice

    14 467 (лента) + 1 099 (публикация) = 15 500 rps в среднем. 80 000 на пике.

| Кластер                  | Кол-во серверов    | CPU             | RAM, Гб         | Диск, Гб        |
|------------------------- | ------------------ | --------------- | --------------- | --------------- |
| Nginx                    | 67                 | 30              | 128             | 128 (SSD)       |
| Backend                  | 67                 | 30              | 256             | 256 (SSD)       |
| Auth microservice        | 10                 | 30              | 128             | 128 (SSD)       |
| Users microservice       | 10                 | 30              | 128             | 128 (SSD)       |
| Posts microservice       | 20                 | 30              | 256             | 128 (SSD)       |
| Attachments microservice | 30                 | 30              | 256             | 128 (SSD)       |
| PostgreSQL               | 100                | 64              | 512             | 48 Пб (HHD), 2 Пб (SSD)   |
| AmazonS3                 | 100                | 30              | 128             | 1764 Тб (HHD), 1 Пб (SSD) |
| Redis                    | 8                  | 8               | 128             | 548 Гб (SSD)       |

## Источники

1. [Статистика по пользователям](https://www.statista.com/topics/1882/instagram)
2. [Шардирование](https://habr.com/ru/companies/oleg-bunin/articles/433370/)
3. [Nginx нагрузка](https://www.nginx.com/blog/testing-the-performance-of-nginx-and-nginx-plus-web-servers/)
